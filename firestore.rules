rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isValidUserDocument() {
      return request.resource.data.keys().hasAny(['profile', 'goals', 'preferences', 'plan']);
    }
    
    // Users collection - main user documents
    match /users/{userId} {
      // Users can only read/write their own documents
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
      
      // Food logs subcollection - one document per day
      match /foodLogs/{date} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
      
      // Body logs subcollection - weight tracking
      match /bodyLogs/{logId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
      
      // AI corrections for learning loop
      match /aiCorrections/{correctionId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        // Once created, corrections shouldn't be modified by users
        allow update: if false;
        allow delete: if false;
      }
      
      // Chat sessions with AI
      match /chatSessions/{sessionId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
        
        // Messages within chat sessions
        match /messages/{messageId} {
          allow read: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update: if false;
          allow delete: if false;
        }
      }
      
      // Meal plans
      match /mealPlans/{planId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
      
      // Saved recipes
      match /savedRecipes/{recipeId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
      
      // Analytics data
      match /analytics/{analyticsId} {
        allow read: if isOwner(userId);
        // Analytics are typically written by cloud functions
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if false;
      }
    }
    
    // Global recipes collection (read-only for users)
    match /recipes/{recipeId} {
      allow read: if isAuthenticated();
      // Only admins/cloud functions can write to global recipes
      allow write: if false;
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
